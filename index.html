<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üìö Spicy Library</title>
<script src="https://sdk.minepi.com/pi-sdk.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
<style>
body{background:#111;color:#fff;font-family:Arial;text-align:center;margin:0;padding:20px;}
button{padding:10px 20px;border:none;border-radius:6px;background:#ff4500;color:#fff;cursor:pointer;margin:5px;}
button:disabled{background:#555;cursor:not-allowed;}
input, textarea, select{padding:8px;margin:5px;width:90%;max-width:400px;}
.hidden{display:none}
.books{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;}
.book{background:#1c1c1c;border:1px solid #333;border-radius:8px;padding:15px;width:220px;font-size:14px;}
.book img{width:200px;border-radius:6px;}
.book h4{margin:10px 0 5px;}
.description{font-size:12px;color:#ccc;height:60px;overflow:hidden;margin:8px 0;}
.owner{font-size:12px;color:#ff4500;}
.language{font-size:12px;color:#aaa;}
.pages{font-size:12px;color:#0f9;font-weight:bold;}
.sales{font-size:12px;color:#ffd700;font-weight:bold;}
.ratings{font-size:14px;margin:8px 0;}
.like-btn, .dislike-btn{background:none;border:none;font-size:18px;cursor:pointer;margin:0 5px;}
.like-btn.liked, .dislike-btn.disliked{opacity:0.6;}
.notice{font-size:14px;color:#ccc;}
.tab-btn{background:#333;margin:10px;padding:10px 20px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
.tab-btn.active{background:#ff4500;}
.tab-content{display:none;}
.tab-content.active{display:block;}
#searchInput{width:80%;max-width:500px;margin:15px auto;display:block;padding:10px;}
.disclaimer{font-size:12px;color:#ccc;margin:20px;padding:10px;border-top:1px solid #333;}
.upload-status{font-size:14px;color:#0f9;margin:10px 0;}
.sales-book{background:#222;border:1px solid #444;border-radius:8px;padding:15px;margin:20px auto;width:90%;max-width:500px;}
.profit{font-size:16px;color:#0f9;font-weight:bold;}
.total-profit{font-size:18px;color:#ffd700;font-weight:bold;margin:20px 0;}
#payoutBtn{background:#00aaff;font-size:16px;padding:15px 30px;margin-top:20px;}
.payout-note{font-size:14px;color:#aaa;margin:15px 0;padding:10px;background:#222;border-radius:8px;}
</style>
</head>
<body>

<div id="login">
  <h1>üìö Spicy Library</h1>
  <p class="notice">Login using Pi Network (must be in Pi Browser)</p>
  <button id="loginBtn">Login with Pi</button>
</div>

<div id="app" class="hidden">
  <h3 id="welcome"></h3>
  <button onclick="toggleAdd()">‚ûï Add Book</button>
  <button onclick="logout()">Logout</button>

  <div>
    <button class="tab-btn active" onclick="openTab('store')">Store</button>
    <button class="tab-btn" onclick="openTab('purchases')">My Purchases</button>
    <button class="tab-btn" onclick="openTab('sales')">My Sales</button>
  </div>

  <div id="store" class="tab-content active">
    <div id="addBook" class="hidden">
      <h3>Add Book</h3>
      <input id="title" placeholder="Book title">
      <input id="price" type="number" min="0.1" step="0.1" placeholder="Price (Pi)">
      <textarea id="description" placeholder="Book description (optional)" rows="3"></textarea>
      <select id="language">
        <option value="">Select language</option>
        <option value="English">English</option>
        <option value="Arabic">Arabic</option>
        <option value="French">French</option>
        <option value="Spanish">Spanish</option>
        <option value="German">German</option>
        <option value="Other">Other</option>
      </select>
      <p>Number of pages (optional)</p>
      <input id="manualPages" type="number" placeholder="e.g. 250" min="1">
      <p>üì∑ Book Cover (images only)</p>
      <button id="uploadCoverBtn">Upload Cover</button>
      <p id="coverStatus" class="upload-status"></p>
      <p>üìÑ Book File (PDF only)</p>
      <button id="uploadPdfBtn">Upload PDF</button>
      <p id="pdfStatus" class="upload-status"></p>
      <br><br>
      <label class="notice">
        <input type="checkbox" id="rights">
        I confirm that I own all rights to this book
      </label><br><br>
      <button id="saveBookBtn" disabled>Save Book</button>
    </div>

    <h3>All Books</h3>
    <input type="text" id="searchInput" placeholder="Search by book title..." oninput="searchBooks()">
    <div class="books" id="books"></div>

    <div class="disclaimer">
      Disclaimer: The website is not responsible for any copyright issues. Each user is fully responsible for the books they upload.
    </div>
  </div>

  <div id="purchases" class="tab-content">
    <h3>My Purchased Books</h3>
    <div class="books" id="myBooks"></div>
  </div>

  <div id="sales" class="tab-content">
    <h3>My Sales & Earnings</h3>
    <p>Platform fee: 30% ‚Äì You get 70% of each sale</p>
    <p>Minimum payout: 5 Pi</p>
    <div class="payout-note">
      <strong>Payout processing time:</strong> Payments are processed manually and can take from 1-2 days up to a maximum of 30 days, depending on volume.
    </div>
    <div id="mySalesBooks"></div>
    <div id="totalEarnings" class="total-profit">Loading earnings...</div>
    <button id="payoutBtn" onclick="requestPayout()" disabled>Request Payout</button>
  </div>
</div>

<script>
// ================= BACKEND URL =================
const BACKEND_URL = "https://pi-backend-77pg.onrender.com";

// ================= PI SDK =================
Pi.init({ version: "2.0", sandbox: false });

let user = null;
let userUid = null;
let coverUrl = "";
let pdfUrl = "";
let pageCount = "Unknown";

// ================= CLOUDINARY =================

document.getElementById("uploadCoverBtn").onclick = () => {
  const btn = document.getElementById("uploadCoverBtn");
  btn.disabled = true; // ‚¨Ö ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ≤ÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ©

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*"; // ŸÅŸÇÿ∑ ÿµŸàÿ±
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) {
      btn.disabled = false; // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ŸÑŸà ŸÑŸÖ ŸäÿÆÿ™ÿßÿ± ŸÖŸÑŸÅ
      return;
    }

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
      const base64 = reader.result; // ÿßŸÑÿµŸàÿ±ÿ© ŸÉŸÄBase64
      try {
        const res = await fetch(`${BACKEND_URL}/upload-cover`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ file: base64 })
        });
        const data = await res.json();
        if (data.success) {
          coverUrl = data.url;
          document.getElementById("coverStatus").innerText = "Cover uploaded!";
          checkSaveReady();
        } else {
          alert("Upload failed");
        }
      } catch (err) {
        alert("Upload failed");
      } finally {
        btn.disabled = false; // ‚¨Ö ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ±ŸÅÿπ
      }
    };
  };
  fileInput.click();
};

document.getElementById("uploadPdfBtn").onclick = () => {
  const btn = document.getElementById("uploadPdfBtn");
  btn.disabled = true; // ‚¨Ö ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ≤ÿ±

  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "application/pdf"; // ŸÅŸÇÿ∑ PDF
  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) {
      btn.disabled = false; // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ŸÑŸà ŸÑŸÖ ŸäÿÆÿ™ÿßÿ± ŸÖŸÑŸÅ
      return;
    }

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
      const base64 = reader.result;
      try {
        const res = await fetch(`${BACKEND_URL}/upload-pdf`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ file: base64 })
        });
        const data = await res.json();
        if (data.success) {
          pdfUrl = data.url;
          pageCount = data.pages || "Unknown";
          document.getElementById("pdfStatus").innerText = "PDF uploaded!";
          checkSaveReady();
        } else {
          alert("Upload failed");
        }
      } catch (err) {
        alert("Upload failed");
      } finally {
        btn.disabled = false; // ‚¨Ö ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ±ŸÅÿπ
      }
    };
  };
  fileInput.click();
};


function checkSaveReady() {
  document.getElementById("saveBookBtn").disabled = !(coverUrl && pdfUrl && user);
}

// ================= ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÖÿπŸÑŸÇ =================
async function onIncompletePaymentFound(incompletePayment) {
  alert("A previous pending payment was detected... Attempting to complete it automatically");
  console.log("Incomplete payment found:", incompletePayment);

  try {
    const response = await fetch("https://pi-backend-77pg.onrender.com/complete-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        paymentId: incompletePayment.identifier,
        txid: incompletePayment.transaction?.txid
      })
    });

    if (!response.ok) {
      const err = await response.json();
      console.error("Failed to complete pending payment:", err);
      alert("Failed to automatically complete the pending payment.\nPlease go to developers.minepi.com to complete or cancel it manually.");
      return;
    }

    alert("Pending payment completed successfully!\nYou can now make new purchases.");
  } catch (err) {
    console.error("Error completing pending payment:", err);
    alert("Error completing pending payment.\nPlease try again or complete it manually from the developer dashboard.");
  }
}
// ================= LOGIN =================
document.getElementById("loginBtn").onclick = async () => {
  try {
    const authResult = await Pi.authenticate(["username", "payments"], onIncompletePaymentFound);
    user = authResult.user;
    userUid = user.uid;

    document.getElementById("welcome").innerText = `Welcome, ${user.username}!`;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

    loadBooks();
    loadMyPurchases();
    loadMySales();

// ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ book.html ŸÖÿπ ÿ∑ŸÑÿ® ÿ¥ÿ±ÿßÿ°
window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const buyId = params.get("buy");
  if (buyId && userUid) {
    // ÿ¨ŸÑÿ® ÿ≥ÿπÿ± ÿßŸÑŸÉÿ™ÿßÿ® ŸÖŸÜ backend
    fetch(`${BACKEND_URL}/book?id=${buyId}`)
      .then(res => res.json())
      .then(json => {
        if (json.success && json.book) {
          buy(json.book.id, json.book.price);
        }
      });
  }
});




  
  } catch (err) {
    alert("Login failed. Open in Pi Browser.");
  }
};

function logout() {
  location.reload();
}

// ================= SAVE BOOK =================
document.getElementById("saveBookBtn").onclick = saveBook;
  async function saveBook() {
  if (!user) return alert("Login required");
  if (!document.getElementById("rights").checked) return alert("Confirm rights");

  const title = document.getElementById("title").value.trim();
  const price = Number(document.getElementById("price").value);
  const description = document.getElementById("description").value.trim();
  const language = document.getElementById("language").value;
  const manualPages = document.getElementById("manualPages").value.trim();

  if (!title || price <= 0 || !coverUrl || !pdfUrl) return alert("Complete all fields");

  const finalPages = manualPages || pageCount;

  const btn = document.getElementById("saveBookBtn");
  btn.disabled = true;
  btn.innerText = "Saving...";

  try {
    const res = await fetch(`${BACKEND_URL}/save-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title, price, description, language, pageCount: finalPages,
        cover: coverUrl, pdf: pdfUrl, owner: user.username, ownerUid: userUid
      })
    });

    if (!res.ok) throw new Error("Upload failed");

    alert("Book uploaded successfully!");
    toggleAdd();
    coverUrl = pdfUrl = "";
    document.getElementById("coverStatus").innerText = "";
    document.getElementById("pdfStatus").innerText = "";
    checkSaveReady();
    loadBooks();
    loadMySales();
  } catch (e) {
    alert("Upload failed");
  } finally {
    btn.disabled = false;
    btn.innerText = "Save Book";
  }
}

// ================= RATE BOOK =================
async function rateBook(bookId, voteType, button) {
  if (!userUid) return alert("Login required");
  try {
    await fetch(`${BACKEND_URL}/rate-book`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, voteType, userUid })
    });

    button.disabled = true;
    button.classList.add(voteType === 'like' ? 'liked' : 'disliked');
    const sibling = button.parentNode.querySelector(voteType === 'like' ? '.dislike-btn' : '.like-btn');
    if (sibling) sibling.disabled = true;
    loadBooks();
    loadMyPurchases();
  } catch (e) {
    alert("Rating failed");
  }
}

// ================= BUY =================
async function buy(bookId, price) {
  if (!userUid) return alert("Login required");
  if (!confirm(`Buy this book for ${price} Pi?`)) return;

  try {
    await Pi.createPayment({
      amount: price,
      memo: "Spicy Library - Book Purchase",
      // üîê metadata ŸÅŸÇÿ∑ (Ÿäÿ≥ÿ™ÿÆÿØŸÖŸáÿß backend)
      metadata: { bookId, userUid }
    }, {
      // üîπ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±
      onReadyForServerApproval: async (paymentId) => {
        await fetch(`${BACKEND_URL}/approve-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId })
        });
      },

      // üîπ ÿßŸÑÿ•ŸÉŸÖÿßŸÑ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± (ÿ®ÿØŸàŸÜ bookId Ÿà userUid)
      onReadyForServerCompletion: async (paymentId, txid) => {
        const res = await fetch(`${BACKEND_URL}/complete-payment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            paymentId,
            txid
          })
        });

        if (!res.ok) {
          alert("Payment failed");
          return;
        }

        const data = await res.json();
        window.open(data.pdfUrl, "_blank");
        alert("Payment successful! The book is now open üìö");

        // ‚úÖ ÿ™ŸÜÿ∏ŸäŸÅ ÿ£Ÿä pending ŸÜŸáÿßÿ¶ŸäŸãÿß
        location.reload();
      },

      onCancel: () => alert("Payment cancelled"),
      onError: (err) => alert("Payment error: " + err.message)
    });
  } catch (e) {
    alert("Use Pi Browser for payment.");
  }
}

// ================= DOWNLOAD PDF =================
async function downloadPdf(bookId) {
  try {
    const res = await fetch(`${BACKEND_URL}/get-pdf`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId, userUid })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error || "Access denied");

    // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ŸÖÿ§ŸÇÿ™ ŸÑŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿµŸäÿ∫ÿ© PDF
    const link = document.createElement("a");
    link.href = data.pdfUrl;
    link.download = `${bookId}.pdf`;  // <-- ŸáŸÜÿß ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ + ÿµŸäÿ∫ÿ© PDF
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

  } catch (err) {
    console.error(err);
    alert("Failed to download PDF.");
  }
}


// ================= LOAD BOOKS =================
async function loadBooks() {
  const box = document.getElementById("books");
  box.innerHTML = "<p>Loading books...</p>";
  try {
    const res = await fetch(`${BACKEND_URL}/books`);
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    const books = json.books;
    box.innerHTML = "";
    if (books.length === 0) return box.innerHTML = "<p>No books available.</p>";

    for (const b of books) {
      const ratingsRes = await fetch(`${BACKEND_URL}/book-ratings`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookId: b.id, userUid })
      });
      const ratingsJson = await ratingsRes.json();
      const { likes = 0, dislikes = 0, userVote = null } = ratingsJson.success ? ratingsJson : {};

      const fullDesc = b.description || "No description";
      const shortDesc = fullDesc.length > 100 ? fullDesc.substring(0, 100) + "..." : fullDesc;
      const showReadMore = fullDesc.length > 100;

      const lang = b.language ? `Language: ${b.language}` : "";
      const owner = `By: ${b.owner}`;
      const pages = b.pageCount !== "Unknown" ? `Pages: ${b.pageCount}` : "";
      const sales = b.salesCount > 0 ? `Sales: ${b.salesCount}` : "";

      box.innerHTML += `
        <div class="book">
          <img src="${b.cover}" alt="Cover">
          <h4>${b.title}</h4>
          <p><strong>${b.price} Pi</strong></p>
          <div class="description" id="desc-${b.id}" data-full="${fullDesc}">${shortDesc}</div>
          ${showReadMore ? `<button class="read-more-btn" onclick="toggleReadMore('${b.id}')">Read more</button>` : ""}
          <div class="owner">${owner}</div>
          <div class="language">${lang}</div>
          <div class="pages">${pages}</div>
          <div class="sales">${sales}</div>
          <div class="ratings">
            <button class="like-btn ${userVote === 'like' ? 'liked' : ''}" onclick="rateBook('${b.id}', 'like', this)" ${userVote || !user ? 'disabled' : ''}>üëç</button> ${likes}
            <button class="dislike-btn ${userVote === 'dislike' ? 'disliked' : ''}" onclick="rateBook('${b.id}', 'dislike', this)" ${userVote || !user ? 'disabled' : ''}>üëé</button> ${dislikes}
          </div>
          <button onclick="buy('${b.id}', ${b.price})" ${!user ? 'disabled' : ''}>Buy with Pi</button>

<button onclick="window.location.href='book.html?id=${b.id}'">View üìñ</button>

          
        </div>`;
    }
  } catch (e) {
    box.innerHTML = "<p>Error loading books. Retrying...</p>";
    setTimeout(loadBooks, 5000);
  }
}

// ================= Read More Toggle =================
function toggleReadMore(bookId) {
  const descEl = document.getElementById(`desc-${bookId}`);
  if (!descEl) return;

  const fullText = descEl.getAttribute("data-full");
  if (descEl.innerText.endsWith("...")) {
    descEl.innerText = fullText;
  } else {
    descEl.innerText = fullText.substring(0, 100) + "...";
  }
}

// ================= LOAD MY PURCHASES =================
async function loadMyPurchases() {
  const box = document.getElementById("myBooks");
  box.innerHTML = "<p>Loading purchases...</p>";
  if (!userUid) return box.innerHTML = "<p>Please log in.</p>";

  try {
    const res = await fetch(`${BACKEND_URL}/my-purchases`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userUid })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    const books = json.books;
    box.innerHTML = "";
    if (books.length === 0) return box.innerHTML = "<p>No purchases yet.</p>";

    for (const b of books) {
      const ratingsRes = await fetch(`${BACKEND_URL}/book-ratings`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookId: b.id, userUid })
      });
      const ratingsJson = await ratingsRes.json();
      const { likes = 0, dislikes = 0, userVote = null } = ratingsJson.success ? ratingsJson : {};

      const desc = b.description ? b.description.substring(0, 100) + "..." : "No description";
      const lang = b.language ? `Language: ${b.language}` : "";
      const owner = `By: ${b.owner}`;
      const pages = b.pageCount !== "Unknown" ? `Pages: ${b.pageCount}` : "";
      const sales = b.salesCount > 0 ? `Sales: ${b.salesCount}` : "";

      box.innerHTML += `
        <div class="book">
          <img src="${b.cover}" alt="Cover">
          <h4>${b.title}</h4>
          <div class="description">${desc}</div>
          <div class="owner">${owner}</div>
          <div class="language">${lang}</div>
          <div class="pages">${pages}</div>
          <div class="sales">${sales}</div>
          <div class="ratings">
            <button class="like-btn ${userVote === 'like' ? 'liked' : ''}" onclick="rateBook('${b.id}', 'like', this)" ${userVote ? 'disabled' : ''}>üëç</button> ${likes}
            <button class="dislike-btn ${userVote === 'dislike' ? 'disliked' : ''}" onclick="rateBook('${b.id}', 'dislike', this)" ${userVote ? 'disabled' : ''}>üëé</button> ${dislikes}
          </div>
          <button onclick="downloadPdf('${b.id}')">Download PDF</button>
        </div>`;
    }
  } catch (e) {
    box.innerHTML = "<p>Error loading purchases. Retrying...</p>";
    setTimeout(loadMyPurchases, 5000);
  }
}

// ================= LOAD MY SALES =================
async function loadMySales() {
  const box = document.getElementById("mySalesBooks");
  const totalBox = document.getElementById("totalEarnings");
  box.innerHTML = "<p>Loading sales...</p>";
  totalBox.innerHTML = "";
  if (!user) return box.innerHTML = "<p>Please log in.</p>";

  try {
    const res = await fetch(`${BACKEND_URL}/my-sales`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user.username })
    });
    const json = await res.json();
    if (!json.success) throw new Error(json.error);

    const books = json.books;
    if (books.length === 0) {
      box.innerHTML = "<p>No books uploaded.</p>";
      totalBox.innerHTML = "<div class='total-profit'>Total earnings: 0 Pi</div>";
      document.getElementById("payoutBtn").disabled = true;
      return;
    }

    let total = 0;
    box.innerHTML = "";
    for (const b of books) {
      const profit = (b.salesCount || 0) * b.price * 0.7;
      total += profit;
      box.innerHTML += `
        <div class="sales-book">
          <img src="${b.cover}" style="width:150px;border-radius:6px;">
          <h4>${b.title}</h4>
          <p>Price: ${b.price} Pi</p>
          <p>Sales: ${b.salesCount || 0}</p>
          <div class="profit">Your earnings: ${profit.toFixed(2)} Pi (70%)</div>
        </div>`;
    }
    totalBox.innerHTML = `<div class='total-profit'>Total earnings: ${total.toFixed(2)} Pi</div>`;
    document.getElementById("payoutBtn").disabled = total < 5;
  } catch (e) {
    box.innerHTML = "<p>Error loading sales.</p>";
  }
}

function isValidPiWallet(address) {
  return typeof address === "string" && address.length === 56;
}


  
// ================= REQUEST PAYOUT =================
async function requestPayout() {
  const totalEarnings = parseFloat(
    document.getElementById("totalEarnings")
      .innerText
      .replace("Total earnings: ", "")
      .replace(" Pi", "")
  ) || 0;

  if (totalEarnings < 5) {
    alert("Minimum payout is 5 Pi.");
    return;
  }

  const walletAddress = prompt(
    `Your current earnings: ${totalEarnings.toFixed(2)} Pi\n\n` +
    `Enter your Pi Wallet address:`
  );

  if (!walletAddress) {
    alert("Wallet address is required.");
    return;
  }

  // ‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿ≠ŸÅÿ∏ÿ© Pi
  if (!isValidPiWallet(walletAddress.trim())) {
    alert(
      "‚ùå Invalid Pi Wallet Address\n\n" +
      "‚Ä¢ Address must be exactly 56 characters\n" +
      "‚Ä¢ Only uppercase letters and numbers\n\n" +
      "Example: GB7XK... (56 chars)"
    );
    return;
  }

  const payoutBtn = document.getElementById("payoutBtn");
  payoutBtn.disabled = true;

  try {
    const res = await fetch(`${BACKEND_URL}/request-payout`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        username: user.username,
        walletAddress: walletAddress.trim()
      })
    });

    const data = await res.json();
    if (!res.ok || !data.success) {
      throw new Error(data.error || "Request failed");
    }

    alert(
      "‚úÖ Payout request sent successfully!\n\n" +
      "Status: Pending\n" +
      "Processing time: 1‚Äì30 days"
    );

    loadMySales();
  } catch (e) {
    alert("‚ùå Failed to send payout request.");
  } finally {
    payoutBtn.disabled = false;
  }
}

// ================= TABS & SEARCH & TOGGLE =================
function openTab(tabName) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(el => el.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add("active");
  if (tabName === "store") loadBooks();
  if (tabName === "purchases") loadMyPurchases();
  if (tabName === "sales") loadMySales();
}

function searchBooks() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const books = document.querySelectorAll("#books .book");
  books.forEach(book => {
    const title = book.querySelector("h4").textContent.toLowerCase();
    book.style.display = title.includes(input) ? "block" : "none";
  });
}

function toggleAdd() {
  if (!user) return alert("Login required");
  document.getElementById("addBook").classList.toggle("hidden");
}
  // ================= LEGAL TEXT =================
const PrivacyPolicyText = `
Privacy Policy - Spicy Library

We respect your privacy and protect your data. We collect:
- Pi Network UID and username
- Purchase history
- Sales data for authors
- Pi wallet addresses (for withdrawals)

We DO NOT collect passwords or private keys.

Your data is used for:
- Login and app functionality
- Payment processing
- Delivering books
- Author earnings and withdrawals

We do not share your data with third parties unless required by law.

Contact: spicy3423@gmail.com
`;

const TermsOfServiceText = `
Terms of Service - Spicy Library

By using Spicy Library, you agree to:
- Use Pi Network for login
- Be responsible for your account activity
- Ensure all content you upload respects copyright

Purchases:
- Made in Pi currency only
- Are final and non-refundable

Authors:
- Receive 70% of each sale
- Minimum withdrawal: 5 Pi
- Processing may take 1‚Äì30 days

Prohibited:
- Uploading stolen content
- Manipulating payments
- Hacking attempts

Contact: spicy3423@gmail.com
`;

// ================= MODAL =================
function openModal(title, content) {
  document.getElementById('modal-title').innerText = title;
  document.getElementById('modal-content').innerText = content;
  document.getElementById('modal').style.display = 'block';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

</script>
  <!-- Modal for Privacy Policy / Terms -->
<div id="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:999;">
  <div style="background:#111;color:#fff;margin:50px auto;padding:20px;border-radius:8px;width:90%;max-width:500px;height:80%;overflow-y:auto;">
    <h2 id="modal-title"></h2>
    <pre id="modal-content" style="white-space:pre-wrap;"></pre>
    <button onclick="closeModal()" style="padding:10px 20px;margin-top:10px;background:#ff4500;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button>
  </div>
</div>

</body>
  <div style="margin:20px;">
  <button onclick="openModal('Privacy Policy', PrivacyPolicyText)">Privacy Policy</button>
  <button onclick="openModal('Terms of Service', TermsOfServiceText)">Terms of Service</button>
</div>

</html>
