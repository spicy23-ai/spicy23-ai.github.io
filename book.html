<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book</title>

<script src="https://sdk.minepi.com/pi-sdk.js"></script>

<style>
body {
  background: #111;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 20px;
  margin: 0;
}

.container {
  max-width: 420px;
  margin: auto;
}

img {
  width: 250px;
  border-radius: 8px;
  margin: 15px 0;
}

h1 {
  font-size: 22px;
  margin: 10px 0;
}

.description {
  font-size: 14px;
  color: #ccc;
  margin: 10px 0;
}

.info {
  font-size: 14px;
  color: #aaa;
  margin: 5px 0;
}

.stats {
  font-size: 14px;
  color: #0f9;
  margin: 8px 0;
}

.ratings {
  margin: 10px 0;
}

.like-btn,
.dislike-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  margin: 0 5px;
}

.like-btn.liked,
.dislike-btn.disliked {
  opacity: 0.6;
}

button {
  padding: 10px 20px;
  background: #ff4500;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin: 8px;
  width: 100%;
  max-width: 280px;
}

button.share {
  background: #00aaff;
}

button:disabled {
  background: #555;
  cursor: not-allowed;
}

.notice {
  font-size: 13px;
  color: #888;
  margin-top: 8px;
}
</style>
</head>

<body>

<div class="container">

  <img id="cover" src="" alt="Book cover">

  <h1 id="title">Loading...</h1>

  <p class="description" id="description"></p>

  <p class="info" id="owner"></p>
  <p class="info" id="language"></p>
  <p class="info" id="pages"></p>
  <p class="info" id="price"></p>
  <p class="info" id="sales"></p>

  <div class="ratings">
    <button class="like-btn" id="likeBtn">üëç</button>
    <span id="likeCount">0</span>
    &nbsp;
    <button class="dislike-btn" id="dislikeBtn">üëé</button>
    <span id="dislikeCount">0</span>
  </div>

  <button id="buyBtn">Buy with Pi ü™ô</button>
  <button id="copyLinkBtn" class="share">Share Link üîó</button>

  <p class="notice">Purchase happens in the main page</p>

</div>

<script>
const BACKEND_URL = "https://pi-backend-77pg.onrender.com";
let bookId = null;
let user = null;
let userUid = null;

const urlParams = new URLSearchParams(window.location.search);
bookId = urlParams.get("id");

Pi.init({ version: "2.0", sandbox: false });

// ================= LOAD BOOK =================
async function loadBook() {
  try {
    const res = await fetch(`${BACKEND_URL}/book?id=${bookId}`);
    const json = await res.json();
    if (!json.success) throw new Error(json.error);
    const b = json.book;

    document.getElementById("title").innerText = b.title;
    document.getElementById("cover").src = b.cover;
    bookPrice = Number(b.price);
document.getElementById("price").innerText = `Price: ${bookPrice} Pi`;

    document.getElementById("description").innerText = b.description || "No description";
    document.getElementById("language").innerText = b.language ? `Language: ${b.language}` : "";
    document.getElementById("pages").innerText = b.pageCount !== "Unknown" ? `Pages: ${b.pageCount}` : "";
    document.getElementById("owner").innerText = `Author: ${b.owner}`;
    document.getElementById("sales").innerText = b.salesCount > 0 ? `Sales: ${b.salesCount}` : "";

    const ratingsRes = await fetch(`${BACKEND_URL}/book-ratings`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ bookId: b.id, userUid })
    });

    const ratingsJson = await ratingsRes.json();
    if (ratingsJson.success) {
      document.getElementById("likeCount").innerText = ratingsJson.likes || 0;
      document.getElementById("dislikeCount").innerText = ratingsJson.dislikes || 0;

      if (ratingsJson.userVote === "like")
        document.getElementById("likeBtn").classList.add("liked");

      if (ratingsJson.userVote === "dislike")
        document.getElementById("dislikeBtn").classList.add("disliked");
    }

  } catch (e) {
    alert("Failed to load book");
    console.error(e);
  }
}

// ================= RATE =================
document.getElementById("likeBtn").onclick = () => rate("like");
document.getElementById("dislikeBtn").onclick = () => rate("dislike");

async function rate(voteType) {
  if (!userUid) return alert("Login required via Pi Browser");
  await fetch(`${BACKEND_URL}/rate-book`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ bookId, voteType, userUid })
  });
  loadBook();
}

// ================= COPY LINK =================
document.getElementById("copyLinkBtn").onclick = () => {
  navigator.clipboard.writeText(window.location.href)
    .then(() => alert("Link copied üîó"));
};

// ================= BUY =================
document.getElementById("buyBtn").onclick = async () => {
  if (!user) {
    const authResult = await Pi.authenticate(["username", "payments"]);
    user = authResult.user;
    userUid = user.uid;
  }

 const price = bookPrice;

  if (!confirm(`Buy this book for ${price} Pi?`)) return;

  await Pi.createPayment({
    amount: price,
    memo: "Spicy Library - Book Purchase",
    metadata: { bookId, userUid }
  }, {
    onReadyForServerApproval: async (paymentId) => {
      await fetch(`${BACKEND_URL}/approve-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paymentId, bookId, userUid })
      });
    },
    onReadyForServerCompletion: async (paymentId, txid) => {
      const res = await fetch(`${BACKEND_URL}/complete-payment`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paymentId, txid, bookId, userUid })
      });
      const data = await res.json();
      window.open(data.pdfUrl, "_blank");
    }
  });
};

window.addEventListener("DOMContentLoaded", loadBook);
</script>

</body>
</html>
